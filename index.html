<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نقشه مسیر نماز</title>
  <style>
    :root{ --bg:#0f172a; --card:#0b1220; --accent:#ffd43b; --muted:#9aa4b2; }
    *{box-sizing:border-box;font-family: Vazirmatn, 'Helvetica Neue', Arial, sans-serif}
    body{margin:0;background:linear-gradient(180deg,#071023 0%, #081027 100%);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:980px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:16px;padding:20px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    header{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    header img{width:56px;height:56px;border-radius:10px;object-fit:cover;border:2px solid rgba(255,255,255,0.06)}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .controls{display:flex;gap:10px;flex-wrap:wrap;margin:14px 0}
    .card{background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;display:flex;gap:10px;align-items:center}
    .card input[type=text]{background:transparent;border:1px dashed rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:inherit}
    .card input[type=file]{color:var(--muted)}
    .btn{background:var(--accent);color:#071023;padding:8px 12px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

    /* Path */
    .stage{margin-top:22px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);border-radius:12px}
    .path{display:flex;align-items:center;gap:24px;overflow:auto;padding:12px 6px}
    .node{position:relative;flex:0 0 auto;width:84px;height:84px;border-radius:999px;display:flex;align-items:center;justify-content:center;cursor:pointer}
    .node .outer{width:84px;height:84px;border-radius:999px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:2px solid rgba(255,255,255,0.04);display:flex;align-items:center;justify-content:center}
    .node .dot{width:40px;height:40px;border-radius:999px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--muted)}
    .node.checked .dot{background:var(--accent);color:#071023}

    /* connectors */
    .connector{height:6px;background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));flex:1;min-width:40px;border-radius:6px}
    .connector.filled{background:linear-gradient(90deg,var(--accent),#ffb84d)}

    /* check animation */
    .check-svg{width:36px;height:36px;transform-origin:center;transition:transform .35s cubic-bezier(.2,.9,.3,1)}
    .node.checked .check-svg{transform:scale(1.05)}

    footer{margin-top:20px;display:flex;align-items:center;justify-content:space-between;gap:10px}
    .prize{display:flex;align-items:center;gap:12px}
    .prize img{width:56px;height:56px;border-radius:10px;object-fit:cover}
    .small{font-size:13px;color:var(--muted)}

    @media (max-width:640px){ .node{width:68px;height:68px}.node .outer{width:68px;height:68px}.dot{width:34px;height:34px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img id="logoPreview" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='56' height='56'><rect width='56' height='56' fill='%230a2340'/><text x='50%' y='55%' font-size='18' fill='%23ffd43b' font-family='Vazirmatn' text-anchor='middle'>نماز</text></svg>" alt="آرم">
      <div>
        <h1>نقشهٔ مسیر نماز — تیک بزن و جایزه بگیر 🎉</h1>
        <p class="lead">روی هر دایره کلیک کن تا تیک بخوره. یا دکمه «نماز خواندم» رو بزن تا مرحلهٔ بعدی تیک بخوره.</p>
      </div>
    </header>

    <div class="controls">
      <div class="card">
        <label class="small" style="margin-right:8px">نام جایزه:</label>
        <input id="prizeName" type="text" placeholder="مثلاً: جایزه آخر هفته" />
      </div>

      <div class="card">
        <label class="small" style="margin-right:8px">آپلود آرم:</label>
        <input id="logoFile" type="file" accept="image/*" />
      </div>

      <div class="card">
        <label class="small" style="margin-right:8px">تعداد مراحل:</label>
        <input id="stepsCount" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="مثلاً: 7" style="width:56px" />
        <button id="applySteps" class="btn ghost">اعمال</button>
      </div>

      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="prayBtn" class="btn">نماز خواندم 🙏</button>
        <button id="resetBtn" class="btn ghost">بازنشانی</button>
      </div>
    </div>

    <section class="stage">
      <div id="path" class="path" aria-hidden="false"></div>
    </section>

    <footer>
      <div class="prize">
        <img id="prizeLogo" src="" alt="لوگو جایزه" onerror="this.style.display='none'"/>
        <div>
          <div id="prizeLabel" style="font-weight:700">جایزهٔ آخر مسیر</div>
          <div class="small">وقتی همه تیک خورد، جایزه رو بگیر 🎁</div>
        </div>
      </div>
      <div class="small">وضعیت ذخیره می‌شود در مرورگر شما</div>
    </footer>
  </div>

  <template id="nodeTpl">
    <div class="node" role="button" tabindex="0">
      <div class="outer">
        <div class="dot">1</div>
        <svg class="check-svg" viewBox="0 0 24 24" style="position:absolute;opacity:0;pointer-events:none">
          <path d="M20 6L9 17l-5-5" fill="none" stroke="#071023" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
      </div>
    </div>
  </template>

  <script>
    // Defaults
    const DEFAULT_STEPS = 7;
    const stateKey = 'namaz_path_state_v1';

    // Elements
    const pathEl = document.getElementById('path');
    const nodeTpl = document.getElementById('nodeTpl').content;
    const prizeNameInput = document.getElementById('prizeName');
    const logoFile = document.getElementById('logoFile');
    const prizeLogo = document.getElementById('prizeLogo');
    const logoPreview = document.getElementById('logoPreview');
    const prizeLabel = document.getElementById('prizeLabel');
    const prayBtn = document.getElementById('prayBtn');
    const resetBtn = document.getElementById('resetBtn');
    const stepsCountInput = document.getElementById('stepsCount');
    const applySteps = document.getElementById('applySteps');

    // Load state
    let state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(stateKey);
        if(raw) return JSON.parse(raw);
      }catch(e){console.warn(e)}
      return { steps: DEFAULT_STEPS, checked: Array(DEFAULT_STEPS).fill(false), prizeName: 'جایزهٔ آخر مسیر', logoData: '' };
    }

    function saveState(){ localStorage.setItem(stateKey, JSON.stringify(state)); }

    function render(){
      pathEl.innerHTML='';
      const steps = state.steps;
      for(let i=0;i<steps;i++){
        if(i>0){
          const connector = document.createElement('div'); connector.className='connector'+(state.checked[i-1]?' filled':''); pathEl.appendChild(connector);
        }
        const node = nodeTpl.cloneNode(true).querySelector('.node');
        const dot = node.querySelector('.dot');
        dot.textContent = (i+1);
        if(state.checked[i]) node.classList.add('checked');
        node.addEventListener('click',()=> toggle(i));
        node.addEventListener('keydown',(e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); toggle(i); } });
        pathEl.appendChild(node);
      }
      // update prize
      prizeLabel.textContent = state.prizeName || 'جایزهٔ آخر مسیر';
      if(state.logoData){ prizeLogo.src = state.logoData; prizeLogo.style.display='block'; logoPreview.src = state.logoData; } else { prizeLogo.style.display='none'; }
      saveState();
    }

    function toggle(i){
      state.checked[i] = !state.checked[i];
      // animate svg opacity
      const node = pathEl.querySelectorAll('.node')[i];
      const svg = node.querySelector('.check-svg');
      if(state.checked[i]){
        svg.style.opacity=1; svg.style.transform='scale(1)';
      } else { svg.style.opacity=0; svg.style.transform='scale(.6)'; }
      // update connectors
      const connectors = pathEl.querySelectorAll('.connector');
      if(i>0) connectors[i-1].classList.toggle('filled', state.checked[i-1]);
      if(i<state.steps-1) connectors[i].classList.toggle('filled', state.checked[i]);
      // set checked class
      node.classList.toggle('checked', state.checked[i]);
      saveState();
    }

    function markNext(){
      const idx = state.checked.indexOf(false);
      if(idx===-1) return; // all done
      state.checked[idx]=true; render();
      // celebration if finished
      if(state.checked.every(Boolean)){
        // small confetti-ish effect (simple)
        for(let i=0;i<24;i++){
          const el = document.createElement('div');
          el.textContent = '✨';
          el.style.position='fixed'; el.style.zIndex=9999; el.style.fontSize = (8+Math.random()*18)+'px';
          el.style.right = (20 + Math.random()*60)+'px'; el.style.top = (30 + Math.random()*60)+'px';
          el.style.opacity=0; document.body.appendChild(el);
          setTimeout(()=>el.style.transition='all 700ms ease',10);
          setTimeout(()=>{ el.style.transform = 'translateY(-80px)'; el.style.opacity=1; },20);
          setTimeout(()=>el.remove(),900);
        }
        alert('تبریک! همه مراحل تیک شد — جایزه: ' + (state.prizeName || 'بدون نام'));
      }
    }

    // wire up controls
    prayBtn.addEventListener('click',()=>{ markNext(); });
    resetBtn.addEventListener('click',()=>{ if(confirm('آیا می‌خواهی همهٔ تیک‌ها پاک شوند؟')){ state.checked = Array(state.steps).fill(false); render(); } });

    prizeNameInput.addEventListener('input',(e)=>{ state.prizeName = e.target.value; render(); });

    logoFile.addEventListener('change',async (e)=>{
      const f = e.target.files && e.target.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = ()=>{ state.logoData = reader.result; render(); };
      reader.readAsDataURL(f);
    });

    applySteps.addEventListener('click',()=>{
      let n = parseInt(stepsCountInput.value || '') || 0;
      if(n<=0 || n>50) { alert('تعداد مراحل را عددی بین 1 تا 50 وارد کن.'); return; }
      // preserve existing checked as much as possible
      const old = state.checked.slice(0,n);
      state.steps = n; state.checked = Array(n).fill(false);
      for(let i=0;i<old.length;i++) state.checked[i]=old[i];
      render();
    });

    // init inputs from state
    function initInputs(){ prizeNameInput.value = state.prizeName || ''; stepsCountInput.value = state.steps; if(state.logoData) logoPreview.src = state.logoData; }

    // initial render
    initInputs(); render();
  </script>
</body>
</html>
